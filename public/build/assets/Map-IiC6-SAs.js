import{createApp as D,ref as t,onMounted as q,toRaw as J,watch as P}from"https://unpkg.com/vue@3/dist/vue.esm-browser.js";async function R(d){var f=["purple","black","blue","purple","darkred","darkgreen","pink","brown","orange","red","Crimson","navy","lightYellow","lemonChiffon","IndianRed","Crimson","FireBrick"],g=await fetch(d+"crimes").then(p=>p.json()),i=0,u={};return g.forEach(p=>{u[p.id]=f[i],i++}),i=0,console.log(u),u}D({setup(){const d=window.location.protocol+"//"+window.location.host+"/api/",f=t(""),g=t(!1),i=t([]),u=t([]),p=t({}),x=t({}),a=t([]),B=t(11),m=t([]),T=t([]),c=t({}),b=t({}),w=t({});let C=new AbortController,j=C.signal;q(async()=>{p.value=new bootstrap.Offcanvas("#LocationInfo");var e=L.layerGroup(),r=L.layerGroup();await fetch(d+"reports/crimes").then(n=>n.json()).then(async n=>{var v=await R(d);n.forEach(k=>{let N=[];k.reports.forEach(h=>{console.log(h);let M=L.circleMarker([Number(h.lat),Number(h.lon)]);M.setStyle({fillColor:v[h.crime_id],radius:4,stroke:!1,fillOpacity:1}),N.push(M),T.value.push([Number(h.lat),Number(h.lon),k.heatmap_intensity])});let I=L.layerGroup(N);m.value['<span class="me-1 ms-1 border" style="border-radius: 5px; background-color:'+v[k.id]+'; width:10px; height:10px; display:inline-block"></span>'+k.name]=I})}).catch(n=>console.error(n)),a.value=L.map("map",{zoomControl:!1,attributionControl:!1,minZoom:3,maxZoom:18,maxBounds:L.latLngBounds([-90,-180],[90,180]),wraparound:!0}).setView([-9.6,-35.71422457695007],B.value),L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{noWrap:!0,worldCopyJump:!0}).addTo(a.value),L.control.zoom({position:"bottomright"}).addTo(a.value),L.control.locate({position:"bottomright",flyTo:!1,drawCircle:!0,showPopup:!1,markerClass:L.circleMarker,strings:{title:"Mostrar minha localização",popup:"Você está dentro de {distance} {unit} deste ponto"},locateOptions:{maxZoom:16}}).addTo(a.value);var l={'<input type="date">':r,"em até 3 meses":e};L.control.layers(l,J(m.value),{position:"topright",collapsed:!1,sortLayers:!1}).addTo(a.value);let o=L.heatLayer(T.value,{radius:15,blur:15,maxZoom:12,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"}});o.addTo(a.value);const y=13;var s=!1;a.value.on("zoomend",function(){let n=a.value.getZoom();if(n>=y&&!s){for(let v in m.value)m.value[v].addTo(a.value);o.setLatLngs([]),s=!0}else if(n<y&&s){for(let v in m.value)m.value[v].remove();o.setLatLngs(T.value),s=!1}})}),P(f,e=>{if(C.abort(),C=new AbortController,j=C.signal,e.includes("booking.com")){_(e,j);return}fetch("https://nominatim.openstreetmap.org/search.php?q="+encodeURI(e)+"&format=jsonv2&addressdetails=1&polygon_geojson=1",{signal:j}).then(r=>r.json()).then(r=>{i.value=[],u.value=r,r.forEach(l=>{let o=l.display_name.indexOf(","),y=l.display_name.substring(o+1).trim(),s=l.address.postcode!==void 0?` - ${l.address.postcode}`:"";i.value.push({display:`${l.name} <span class="text-black-50 fst-italic">- ${y}${s}</span>`})})}).catch(r=>{r.name!=="AbortError"&&console.error("Another error: ",r)})});function _(e,r){var l;fetch(d+"external",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}).then(o=>o.text()).then(o=>{let s=new DOMParser().parseFromString(o,"text/html");l=s.querySelector("#hp_hotel_name > div > h2").innerText;let n=s.querySelector("#hotel_address").getAttribute("data-atlas-latlng").split(",");return fetch("https://nominatim.openstreetmap.org/reverse?lat="+n[0]+"&lon="+n[1]+"&format=jsonv2",{signal:r})}).then(o=>o.json()).then(o=>{O(),i.value=[],u.value=[],o.name=l,c.value=o,S()}).catch(o=>console.error(o))}function O(){g.value=!1,f.value=""}function G(e){O(),c.value=u.value[e],S()}function S(){x.value={},Z(),z(),A(),E()}function Z(){Object.keys(b.value).length!==0&&a.value.removeLayer(b.value),b.value=L.geoJSON(c.value.geojson,{style:{fill:!1}}),b.value.addTo(a.value)}function z(){Object.keys(w.value).length!==0&&a.value.removeLayer(w.value),w.value=L.marker([Number(c.value.lat),Number(c.value.lon)]),w.value.addTo(a.value)}function A(){let e=c.value.boundingbox.map(Number);a.value.fitBounds([[e[0],e[2]],[e[1],e[3]]]),a.value.panBy([-80,0])}function E(){fetch(d+"crimes/statistics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c.value.address)}).then(e=>e.json()).then(e=>{x.value=e}).catch(e=>console.error(e)),p.value.show()}return{query:f,recommendations:i,barFocus:g,currentLocation:c,statistics:x,selectSearchBarItem:G}}}).mount("#app");
