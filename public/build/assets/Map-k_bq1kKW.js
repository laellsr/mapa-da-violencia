import{createApp as q,ref as t,onMounted as D,toRaw as I,watch as J}from"https://unpkg.com/vue@3/dist/vue.esm-browser.js";q({setup(){const y=window.location.protocol+"//"+window.location.host+"/api/",g=t(""),C=t(!1),m=t([]),b=t([]),k=t({}),w=t({}),a=t([]),S=t(11),c=t([]),T=t([]),u=t({}),d=t({}),v=t({});let h=new AbortController,x=h.signal;D(async()=>{k.value=new bootstrap.Offcanvas("#LocationInfo");var e=L.layerGroup(),r=L.layerGroup();await fetch(y+"reports/crimes").then(n=>n.json()).then(n=>{n.forEach(i=>{let O=[];i.reports.forEach(f=>{let E=L.marker([Number(f.lat),Number(f.lon)]);O.push(E),T.value.push([Number(f.lat),Number(f.lon),i.heatmap_intensity])});let B=L.layerGroup(O);c.value[i.name]=B})}).catch(n=>console.error(n)),a.value=L.map("map",{zoomControl:!1,attributionControl:!1,minZoom:3,maxZoom:18,maxBounds:L.latLngBounds([-90,-180],[90,180]),wraparound:!0}).setView([-9.6,-35.71422457695007],S.value),L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{noWrap:!0,worldCopyJump:!0}).addTo(a.value),L.control.zoom({position:"bottomright"}).addTo(a.value),L.control.locate({position:"bottomright",flyTo:!1,drawCircle:!0,showPopup:!1,markerClass:L.circleMarker,strings:{title:"Mostrar minha localização",popup:"Você está dentro de {distance} {unit} deste ponto"},locateOptions:{maxZoom:16}}).addTo(a.value);var l={'<input type="date">':r,"em até 3 meses":e};L.control.layers(l,I(c.value),{position:"topright",collapsed:!1,sortLayers:!0}).addTo(a.value);let o=L.heatLayer(T.value,{radius:15,blur:15,maxZoom:12,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"}});o.addTo(a.value);const p=13;var s=!1;a.value.on("zoomend",function(){let n=a.value.getZoom();if(n>=p&&!s){for(let i in c.value)c.value[i].addTo(a.value);o.setLatLngs([]),s=!0}else if(n<p&&s){for(let i in c.value)c.value[i].remove();o.setLatLngs(T.value),s=!1}})}),J(g,e=>{if(h.abort(),h=new AbortController,x=h.signal,e.includes("booking.com")){M(e,x);return}fetch("https://nominatim.openstreetmap.org/search.php?q="+encodeURI(e)+"&format=jsonv2&addressdetails=1&polygon_geojson=1",{signal:x}).then(r=>r.json()).then(r=>{m.value=[],b.value=r,r.forEach(l=>{let o=l.display_name.indexOf(","),p=l.display_name.substring(o+1).trim(),s=l.address.postcode!==void 0?` - ${l.address.postcode}`:"";m.value.push({display:`${l.name} <span class="text-black-50 fst-italic">- ${p}${s}</span>`})})}).catch(r=>{r.name!=="AbortError"&&console.error("Another error: ",r)})});function M(e,r){var l;fetch(y+"external",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}).then(o=>o.text()).then(o=>{let s=new DOMParser().parseFromString(o,"text/html");l=s.querySelector("#hp_hotel_name > div > h2").innerText;let n=s.querySelector("#hotel_address").getAttribute("data-atlas-latlng").split(",");return fetch("https://nominatim.openstreetmap.org/reverse?lat="+n[0]+"&lon="+n[1]+"&format=jsonv2",{signal:r})}).then(o=>o.json()).then(o=>{j(),m.value=[],b.value=[],o.name=l,u.value=o,N()}).catch(o=>console.error(o))}function j(){C.value=!1,g.value=""}function G(e){j(),u.value=b.value[e],N()}function N(){w.value={},Z(),_(),z(),A()}function Z(){Object.keys(d.value).length!==0&&a.value.removeLayer(d.value),d.value=L.geoJSON(u.value.geojson,{style:{fill:!1}}),d.value.addTo(a.value)}function _(){Object.keys(v.value).length!==0&&a.value.removeLayer(v.value),v.value=L.marker([Number(u.value.lat),Number(u.value.lon)]),v.value.addTo(a.value)}function z(){let e=u.value.boundingbox.map(Number);a.value.fitBounds([[e[0],e[2]],[e[1],e[3]]])}function A(){fetch(y+"crimes/statistics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u.value.address)}).then(e=>e.json()).then(e=>{w.value=e}).catch(e=>console.error(e)),k.value.show()}return{query:g,recommendations:m,barFocus:C,currentLocation:u,statistics:w,selectSearchBarItem:G}}}).mount("#app");
