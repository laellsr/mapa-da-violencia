import{createApp as w,ref as s,onMounted as _,watch as x,toRaw as j}from"https://unpkg.com/vue@3/dist/vue.esm-browser.js";w({setup(){const c=window.location.protocol+"//"+window.location.host+"/api/",u=s([]),m=s(""),h=s(""),f=s(""),a=s({}),d=s(""),n=s([]),b=s([]);let i=new AbortController,p=i.signal;_(async()=>{fetch(c+"crimes").then(e=>e.json()).then(e=>{u.value=e}).catch(e=>console.log(e))}),x(d,e=>{if(i.abort(),i=new AbortController,p=i.signal,e.includes("booking.com")){v(e,p);return}fetch("https://nominatim.openstreetmap.org/search.php?q="+encodeURI(e)+"&format=jsonv2&addressdetails=1&polygon_geojson=1",{signal:p}).then(t=>t.json()).then(t=>{n.value=[],b.value=t,t.forEach(o=>{let r=o.display_name.indexOf(","),y=o.display_name.substring(r+1).trim(),l=o.address.postcode!==void 0?` - ${o.address.postcode}`:"";n.value.push({display:`${d.value} <span class="text-white-50 fst-italic">- ${y}${l}</span>`,element:o})}),a.value=t[0]}).catch(t=>{t.name!=="AbortError"&&console.error("Another error: ",t)})});function v(e,t){var o;fetch(c+"external",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})}).then(r=>r.text()).then(r=>{let l=new DOMParser().parseFromString(r,"text/html");o=l.querySelector("#hp_hotel_name > div > h2").innerText;let g=l.querySelector("#hotel_address").getAttribute("data-atlas-latlng").split(",");return fetch("https://nominatim.openstreetmap.org/reverse?lat="+g[0]+"&lon="+g[1]+"&format=jsonv2",{signal:t})}).then(r=>r.json()).then(r=>{n.value=[],n.value.push({display:`${o} <span class="text-white-50 fst-italic">- ${r.display_name}</span>`,element:r}),a.value=r}).catch(r=>console.error(r))}function S(){document.getElementById("btnReportSubmit").setAttribute("disabled","disabled");let e=j(a.value);const t={crime_id:m.value,date:h.value,time:f.value,osm_type:e.osm_type,osm_id:e.osm_id,lat:e.lat,lon:e.lon,suburb:e.address.suburb,city:e.address.city,state:e.address.state,region:e.address.region,country:e.address.country};console.log(t),fetch(c+"reports/store",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(o=>o.json()).then(o=>{Swal.fire({icon:"success",title:"Feito!",text:"Sua denúncia foi registrada e a aplicação será recarregada em instantes.",showConfirmButton:!1})}).catch(o=>{Swal.fire({icon:"error",title:"Erro!",text:JSON.stringify(o.errors)??"O servidor não conseguiu processar a sua requisição. Tente novamente mais tarde."}),document.getElementById("btnReportSubmit").removeAttribute("disabled")})}return{query:d,recommendations:n,crimeList:u,reportCrime:m,reportDate:h,reportTime:f,reportPlace:a,submitReportForm:S}}}).mount("#modalApp");
