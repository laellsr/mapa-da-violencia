import{createApp as P,ref as e,onMounted as U,toRaw as W,watch as G}from"https://unpkg.com/vue@3/dist/vue.esm-browser.js";P({setup(){const k=window.location.protocol+"//"+window.location.host+"/api/",b=e(""),j=e(!1),w=e([]),S=e([]),x=e(""),N=e(!1),C=e([]),O=e([]),v=e({}),M=e({}),n=e([]),Z=e(11),d=e([]),T=e([]),c=e({}),h=e({}),f=e({});let i=new AbortController,p=i.signal;const _=e([]),A=e(0),D=e([]);U(async()=>{M.value=new bootstrap.Offcanvas("#LocationInfo");var a=L.layerGroup(),o=L.layerGroup();await fetch(k+"reports/crimes").then(s=>s.json()).then(s=>{s.forEach(u=>{let y=[];u.reports.forEach(g=>{let F=L.marker([Number(g.lat),Number(g.lon)]);y.push(F),T.value.push([Number(g.lat),Number(g.lon),u.heatmap_intensity])});let R=L.layerGroup(y);d.value[u.name]=R,_.value.push(y.length),D.value.push(u.name),A.value+=y.length})}).catch(s=>console.error(s)),n.value=L.map("map",{zoomControl:!1,attributionControl:!1,minZoom:3,maxZoom:18,maxBounds:L.latLngBounds([-90,-180],[90,180]),wraparound:!0}).setView([-9.6,-35.71422457695007],Z.value),L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{noWrap:!0,worldCopyJump:!0}).addTo(n.value),L.control.zoom({position:"bottomright"}).addTo(n.value),L.control.locate({position:"bottomright",flyTo:!1,drawCircle:!0,showPopup:!1,markerClass:L.circleMarker,strings:{title:"Mostrar minha localização",popup:"Você está dentro de {distance} {unit} deste ponto"},locateOptions:{maxZoom:16}}).addTo(n.value);var r={'<input type="date">':o,"em até 3 meses":a};L.control.layers(r,W(d.value),{position:"topright",collapsed:!1,sortLayers:!0}).addTo(n.value);let t=L.heatLayer(T.value,{radius:15,blur:15,maxZoom:12,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"}});t.addTo(n.value);const m=13;var l=!1;n.value.on("zoomend",function(){let s=n.value.getZoom();if(s>=m&&!l){for(let u in d.value)d.value[u].addTo(n.value);t.setLatLngs([]),l=!0}else if(s<m&&l){for(let u in d.value)d.value[u].remove();t.setLatLngs(T.value),l=!1}})}),G(b,a=>{if(i.abort(),i=new AbortController,p=i.signal,a.includes("booking.com")){q(a,p);return}fetch("https://nominatim.openstreetmap.org/search.php?q="+encodeURI(a)+"&format=jsonv2&addressdetails=1&polygon_geojson=1",{signal:p}).then(o=>o.json()).then(o=>{w.value=[],S.value=o,o.forEach(r=>{let t=r.display_name.indexOf(","),m=r.display_name.substring(t+1).trim(),l=r.address.postcode!==void 0?` - ${r.address.postcode}`:"";w.value.push({display:`${r.name} <span class="text-black-50 fst-italic">- ${m}${l}</span>`})})}).catch(o=>{o.name!=="AbortError"&&console.error("Another error: ",o)})});function q(a,o){var r;fetch(k+"external",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:a})}).then(t=>t.text()).then(t=>{let l=new DOMParser().parseFromString(t,"text/html");r=l.querySelector("#hp_hotel_name > div > h2").innerText;let s=l.querySelector("#hotel_address").getAttribute("data-atlas-latlng").split(",");return fetch("https://nominatim.openstreetmap.org/reverse?lat="+s[0]+"&lon="+s[1]+"&format=jsonv2",{signal:o})}).then(t=>t.json()).then(t=>{I(),t.name=r,c.value=t,$(),B(),E(),M.value.show()}).catch(t=>console.error(t))}function I(){j.value=!1,b.value=""}function z(a){I(),c.value=S.value[a],$(),B(),E(),M.value.show()}G(x,a=>{i.abort(),i=new AbortController,p=i.signal,fetch("https://nominatim.openstreetmap.org/search.php?q="+encodeURI(a)+"&format=jsonv2&addressdetails=1&polygon_geojson=1",{signal:p}).then(o=>o.json()).then(o=>{C.value=[],O.value=o,o.forEach(r=>{let t=r.display_name.indexOf(","),m=r.display_name.substring(t+1).trim(),l=r.address.postcode!==void 0?` - ${r.address.postcode}`:"";C.value.push({display:`${r.name} <span class="text-black-50 fst-italic">- ${m}${l}</span>`})})}).catch(o=>{o.name!=="AbortError"&&console.error("Another error: ",o)})});function J(a){N.value=!1,v.value=O.value[a],x.value=v.value.name,localStorage.setItem("currentLocationModal",JSON.stringify(v.value))}function $(){Object.keys(h.value).length!==0&&n.value.removeLayer(h.value),h.value=L.geoJSON(c.value.geojson,{style:{fill:!1}}),h.value.addTo(n.value)}function B(){Object.keys(f.value).length!==0&&n.value.removeLayer(f.value),f.value=L.marker([Number(c.value.lat),Number(c.value.lon)]),f.value.addTo(n.value)}function E(){let a=c.value.boundingbox.map(Number);n.value.fitBounds([[a[0],a[2]],[a[1],a[3]]])}return{query:b,recommendations:w,barFocus:j,currentLocation:c,selectSearchBarItem:z,queryModal:x,recommendationsModal:C,barFocusModal:N,currentLocationModal:v,selectSearchBarItemModal:J,maceioCrimesData:_,maceioCrimesTotalData:A,maceioCrimesLabelData:D}}}).mount("#app");
