import{createApp as H,ref as l,onMounted as Y,toRaw as I,watch as K}from"https://unpkg.com/vue@3/dist/vue.esm-browser.js";async function Q(m){var f=["purple","black","blue","purple","darkred","darkgreen","pink","brown","orange","red","Crimson","navy","lightYellow","lemonChiffon","IndianRed","Crimson","FireBrick"],h=await fetch(m+"crimes").then(c=>c.json()),v=0,y={};return h.forEach(c=>{y[c.id]=f[v],v++}),v=0,y}H({setup(){const m=window.location.protocol+"//"+window.location.host+"/api/",f=l(!0),h=l(!1),v=l(""),y=l(!1),c=l([]),T=l([]);let x=new Date;x.setMonth(x.getMonth()-3);const b=l(x.toISOString().split("T")[0]),M=l({}),S=l({}),o=l([]),_=l(11),r=l([]),N=l({}),g=l([]),p=l({}),i=l({}),C=l({}),w=l({});let k=new AbortController,O=k.signal;Y(async()=>{M.value=new bootstrap.Offcanvas("#LocationInfo"),L.layerGroup(),L.layerGroup(),await D(),o.value=L.map("map",{zoomControl:!1,attributionControl:!1,minZoom:3,maxZoom:18,maxBounds:L.latLngBounds([-90,-180],[90,180]),wraparound:!0}).setView([-9.6,-35.71422457695007],_.value),L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{noWrap:!0,worldCopyJump:!0}).addTo(o.value),L.control.zoom({position:"bottomright"}).addTo(o.value),L.control.locate({position:"bottomright",flyTo:!1,drawCircle:!0,showPopup:!1,markerClass:L.circleMarker,strings:{title:"Mostrar minha localização",popup:"Você está dentro de {distance} {unit} deste ponto"},locateOptions:{maxZoom:16}}).addTo(o.value),L.Control.DatePicker=L.Control.extend({onAdd:function(t){var e=L.DomUtil.create("div");e.id="datePickerContainer",e.className="bg-white rounded shadow-sm border border-dark p-2",L.DomEvent.disableClickPropagation(e);var d=L.DomUtil.create("label","",e);d.innerHTML="Serão mostrados apenas as ocorrências até a data selecionada. Por padrão, são exibidos apenas os dados dos últimos 3 meses.",d.className="form-label";var s=L.DomUtil.create("input","",e);return s.type="date",s.className="form-control form-control-sm",s.value=b.value,s.onchange=function(u){console.log("change"),b.value=u.target.value,z()},e},onRemove:function(t){}}),L.control.datepicker=function(t){return new L.Control.DatePicker(t)},L.control.datepicker({position:"topright"}).addTo(o.value),N.value=L.control.layers({},I(r.value),{position:"topright",collapsed:!1,sortLayers:!1}).addTo(o.value),p.value=L.heatLayer(g.value,{radius:15,blur:15,maxZoom:12,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"}}),p.value.addTo(o.value);const a=13;var n=!1;o.value.on("zoomend",function(){let t=o.value.getZoom();if(t>=a&&!n){for(let e in r.value)r.value[e].addTo(o.value);p.value.setLatLngs([]),n=!0}else if(t<a&&n){for(let e in r.value)r.value[e].remove();p.value.setLatLngs(g.value),n=!1}}),P()});function E(){f.value=!0}function P(){f.value=!1}async function z(){E(),G();for(let a in r.value)r.value[a].remove();p.value.setLatLngs([]),g.value=[],await D(),p.value.setLatLngs(g.value);for(let a in r.value)r.value[a].addTo(o.value);o.value.removeControl(N.value),N.value=L.control.layers({},I(r.value),{position:"topright",collapsed:!1,sortLayers:!1}).addTo(o.value),U(),P()}function G(){o.value.touchZoom.disable(),o.value.doubleClickZoom.disable(),o.value.scrollWheelZoom.disable(),o.value.boxZoom.disable()}function U(){o.value.touchZoom.enable(),o.value.doubleClickZoom.enable(),o.value.scrollWheelZoom.enable(),o.value.boxZoom.enable()}async function D(){try{const n=await(await fetch(m+"reports/crimes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:b.value})})).json(),t=await Q(m);r.value=[],n.forEach(e=>{let d=[];e.reports.forEach(u=>{let j=L.circleMarker([Number(u.lat),Number(u.lon)]);j.setStyle({fillColor:t[u.crime_id],radius:6,stroke:!1,fillOpacity:1}),j.bindTooltip(e.name),d.push(j),g.value.push([Number(u.lat),Number(u.lon),e.heatmap_intensity])});let s=L.layerGroup(d);r.value['<span class="me-1 ms-1 border" style="border-radius: 5px; background-color:'+t[e.id]+'; width:10px; height:10px; display:inline-block"></span>'+e.name]=s})}catch(a){console.error(a)}}let Z=null;K(v,a=>{if(h.value=!0,k.abort(),k=new AbortController,O=k.signal,a.includes("booking.com")){J(a,O);return}Z&&clearTimeout(Z),Z=setTimeout(()=>{fetch("https://nominatim.openstreetmap.org/search.php?q="+encodeURI(a)+"&format=jsonv2&addressdetails=1&polygon_geojson=1",{signal:O}).then(n=>n.json()).then(n=>{c.value=[],T.value=n,n.forEach(t=>{let e=t.display_name.indexOf(","),d=t.display_name.substring(e+1).trim(),s=t.address.postcode!==void 0?` - ${t.address.postcode}`:"";c.value.push({display:`${t.name} <span class="text-black-50 fst-italic">- ${d}${s}</span>`})})}).catch(n=>{n.name!=="AbortError"&&console.error("Another error: ",n)}),h.value=!1},1e3)});function J(a,n){var t;fetch(m+"external",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:a})}).then(e=>e.text()).then(e=>{let s=new DOMParser().parseFromString(e,"text/html");t=s.querySelector("#hp_hotel_name > div > h2").innerText;let u=s.querySelector("#hotel_address").getAttribute("data-atlas-latlng").split(",");return fetch("https://nominatim.openstreetmap.org/reverse?lat="+u[0]+"&lon="+u[1]+"&format=jsonv2",{signal:n})}).then(e=>e.json()).then(e=>{B(),c.value=[],T.value=[],e.name=t,i.value=e,A()}).catch(e=>console.error(e))}function B(){y.value=!1,v.value=""}function R(a){B(),i.value=T.value[a],A()}function A(){S.value={},q(),F(),$(),W()}function q(){Object.keys(C.value).length!==0&&o.value.removeLayer(C.value),C.value=L.geoJSON(i.value.geojson,{style:{fill:!1}}),C.value.addTo(o.value)}function F(){Object.keys(w.value).length!==0&&o.value.removeLayer(w.value),w.value=L.marker([Number(i.value.lat),Number(i.value.lon)]),w.value.addTo(o.value),w.value.bindPopup(i.value.name).openPopup()}function $(){let a=i.value.boundingbox.map(Number);o.value.fitBounds([[a[0],a[2]],[a[1],a[3]]]),o.value.panBy([-80,0])}function W(){i.value.address.date=b.value,fetch(m+"crimes/statistics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i.value.address)}).then(a=>a.json()).then(a=>{S.value=a}).catch(a=>console.error(a)),M.value.show()}return{query:v,recommendations:c,barFocus:y,showLoading:f,showSearchBarLoading:h,currentLocation:i,statistics:S,dateFilter:b,selectSearchBarItem:R}}}).mount("#app");
