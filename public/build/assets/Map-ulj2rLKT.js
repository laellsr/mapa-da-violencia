import{createApp as Y,ref as t,onMounted as K,toRaw as _,watch as Q}from"https://unpkg.com/vue@3/dist/vue.esm-browser.js";async function V(m){var f=["purple","black","blue","purple","darkred","darkgreen","pink","brown","orange","red","Crimson","navy","lightYellow","lemonChiffon","IndianRed","Crimson","FireBrick"],h=await fetch(m+"crimes").then(c=>c.json()),v=0,y={};return h.forEach(c=>{y[c.id]=f[v],v++}),v=0,y}Y({setup(){const m=window.location.protocol+"//"+window.location.host+"/api/",f=t(!0),h=t(!1),v=t(""),y=t(!1),c=t([]),T=t([]);let x=new Date;x.setMonth(x.getMonth()-3);const b=t(x.toISOString().split("T")[0]),P=t({}),S=t({}),o=t([]),E=t(11),r=t([]),N=t({}),g=t([]),p=t({}),O=t(!0),i=t({}),C=t({}),w=t({});let k=new AbortController,Z=k.signal;K(async()=>{P.value=new bootstrap.Offcanvas("#LocationInfo"),L.layerGroup(),L.layerGroup(),await B(),o.value=L.map("map",{zoomControl:!1,attributionControl:!1,minZoom:3,maxZoom:18,maxBounds:L.latLngBounds([-90,-180],[90,180]),wraparound:!0}).setView([-9.6,-35.71422457695007],E.value),L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{noWrap:!0,worldCopyJump:!0}).addTo(o.value),L.control.zoom({position:"bottomright"}).addTo(o.value),L.control.locate({position:"bottomright",flyTo:!1,drawCircle:!0,showPopup:!1,markerClass:L.circleMarker,strings:{title:"Mostrar minha localização",popup:"Você está dentro de {distance} {unit} deste ponto"},locateOptions:{maxZoom:16}}).addTo(o.value),L.Control.DatePicker=L.Control.extend({onAdd:function(l){var e=L.DomUtil.create("div");e.id="datePickerContainer",e.className="bg-white rounded shadow-sm border border-dark p-2",L.DomEvent.disableClickPropagation(e);var d=L.DomUtil.create("label","",e);d.innerHTML="Serão mostrados apenas as ocorrências até a data selecionada. Por padrão, são exibidos apenas os dados dos últimos 3 meses.",d.className="form-label";var s=L.DomUtil.create("input","",e);return s.type="date",s.className="form-control form-control-sm",s.value=b.value,s.onchange=function(u){console.log("change"),b.value=u.target.value,z()},e},onRemove:function(l){}}),L.control.datepicker=function(l){return new L.Control.DatePicker(l)},L.control.datepicker({position:"topright"}).addTo(o.value),N.value=L.control.layers({},_(r.value),{position:"topright",collapsed:!1,sortLayers:!1}).addTo(o.value),p.value=L.heatLayer(g.value,{radius:15,blur:15,maxZoom:12,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"}}),p.value.addTo(o.value);const a=13;var n=!1;o.value.on("zoomend",function(){let l=o.value.getZoom();if(l>=a&&!n){for(let e in r.value)r.value[e].addTo(o.value);p.value.setLatLngs([]),n=!0,O.value=!1}else if(l<a&&n){for(let e in r.value)r.value[e].remove();p.value.setLatLngs(g.value),n=!1,O.value=!0}}),D()});function G(){f.value=!0}function D(){f.value=!1}async function z(){G(),U();for(let a in r.value)r.value[a].remove();p.value.setLatLngs([]),g.value=[],await B(),p.value.setLatLngs(g.value);for(let a in r.value)r.value[a].addTo(o.value);o.value.removeControl(N.value),N.value=L.control.layers({},_(r.value),{position:"topright",collapsed:!1,sortLayers:!1}).addTo(o.value),J(),D()}function U(){o.value.touchZoom.disable(),o.value.doubleClickZoom.disable(),o.value.scrollWheelZoom.disable(),o.value.boxZoom.disable()}function J(){o.value.touchZoom.enable(),o.value.doubleClickZoom.enable(),o.value.scrollWheelZoom.enable(),o.value.boxZoom.enable()}async function B(){try{const n=await(await fetch(m+"reports/crimes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:b.value})})).json(),l=await V(m);r.value=[],n.forEach(e=>{let d=[];e.reports.forEach(u=>{let M=L.circleMarker([Number(u.lat),Number(u.lon)]);M.setStyle({fillColor:l[u.crime_id],radius:6,stroke:!1,fillOpacity:1}),M.bindTooltip(e.name),d.push(M),g.value.push([Number(u.lat),Number(u.lon),e.heatmap_intensity])});let s=L.layerGroup(d);r.value['<span class="me-1 ms-1 border" style="border-radius: 5px; background-color:'+l[e.id]+'; width:10px; height:10px; display:inline-block"></span>'+e.name]=s})}catch(a){console.error(a)}}let j=null;Q(v,a=>{if(h.value=!0,k.abort(),k=new AbortController,Z=k.signal,a.includes("booking.com")){R(a,Z);return}j&&clearTimeout(j),j=setTimeout(()=>{fetch("https://nominatim.openstreetmap.org/search.php?q="+encodeURI(a)+"&format=jsonv2&addressdetails=1&polygon_geojson=1",{signal:Z}).then(n=>n.json()).then(n=>{c.value=[],T.value=n,n.forEach(l=>{let e=l.display_name.indexOf(","),d=l.display_name.substring(e+1).trim(),s=l.address.postcode!==void 0?` - ${l.address.postcode}`:"";c.value.push({display:`${l.name} <span class="text-black-50 fst-italic">- ${d}${s}</span>`})})}).catch(n=>{n.name!=="AbortError"&&console.error("Another error: ",n)}),h.value=!1},1e3)});function R(a,n){var l;fetch(m+"external",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:a})}).then(e=>e.text()).then(e=>{let s=new DOMParser().parseFromString(e,"text/html");l=s.querySelector("#hp_hotel_name > div > h2").innerText;let u=s.querySelector("#hotel_address").getAttribute("data-atlas-latlng").split(",");return fetch("https://nominatim.openstreetmap.org/reverse?lat="+u[0]+"&lon="+u[1]+"&format=jsonv2",{signal:n})}).then(e=>e.json()).then(e=>{A(),c.value=[],T.value=[],e.name=l,i.value=e,I()}).catch(e=>console.error(e))}function A(){y.value=!1,v.value=""}function q(a){A(),i.value=T.value[a],I()}function I(){S.value={},F(),$(),W(),H()}function F(){Object.keys(C.value).length!==0&&o.value.removeLayer(C.value),C.value=L.geoJSON(i.value.geojson,{style:{fill:!1}}),C.value.addTo(o.value)}function $(){Object.keys(w.value).length!==0&&o.value.removeLayer(w.value),w.value=L.marker([Number(i.value.lat),Number(i.value.lon)]),w.value.addTo(o.value),w.value.bindPopup(i.value.name).openPopup()}function W(){let a=i.value.boundingbox.map(Number);o.value.fitBounds([[a[0],a[2]],[a[1],a[3]]]),o.value.panBy([-80,0])}function H(){i.value.address.date=b.value,fetch(m+"crimes/statistics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i.value.address)}).then(a=>a.json()).then(a=>{S.value=a}).catch(a=>console.error(a)),P.value.show()}return{query:v,recommendations:c,barFocus:y,showLoading:f,showSearchBarLoading:h,heatmapGradientBar:O,currentLocation:i,statistics:S,dateFilter:b,selectSearchBarItem:q}}}).mount("#app");
